{% extends "base/theme_base.html" %}

{% block page_title %}{{book.name}} - 书籍详情{% endblock %}

{% block single_js %}
	<script src="{{STATIC_URL}}base/js/secure.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			$("#tab1").delegate("#pre, #next, #num", "click", function(){
				cmtPageTurn(this, '{{book.id}}');
			});
			$("#tab1").delegate("#goto_page", "click", function(){
				cmtPageTurn(this, '{{book.id}}');
			});
			
			$("#cmt_all, #cmt_positive, #cmt_normal, #cmt_negative").delegate("#all_up, #positive_up, #normal_up, #negative_up", "click", function(){
				var pra = $(this).attr("rel");
				pra = pra.split(",");
				requestCmts(parseInt(pra[0]), pra[1], '{{book.id}}');
			});
			
			$("#cmt_all, #cmt_positive, #cmt_normal, #cmt_negative").delegate("#all_down, #positive_down, #normal_down, #negative_down", "click", function(){
				var pra = $(this).attr("rel");
				pra = pra.split(",");
				requestCmts(parseInt(pra[0]), pra[1], '{{book.id}}');
			});
			
			$("#cmt_all, #cmt_positive, #cmt_normal, #cmt_negative").delegate("#all_num, #positive_num, #normal_num, #negative_num", "click", function(){
				var pra = $(this).attr("rel");
				pra = pra.split(",");
				requestCmts(parseInt(pra[0]), pra[1], '{{book.id}}');
			});
			
		});
		
		function requestCmts(page, column, bookId){
			$.ajax({
				url: "/books/page_book_cmts/" + bookId, 
				data: {"page": page, "column": column}, 
				type: "get", 
				async: "true", 
				success: function(data){
					if(data.status=="success"){
						$("#cmt_"+column).html(data.html);
					}else{
						alert(data.status);
					}
				}, 
				error: function(){
					alert("error");
				}, 
				dataType: "json"
			});
		}
		
		//检查字符串是否为空 true表示为空 false表示不为空
		function isNull(value){
			if(trim(value)==""){
				return true;
			}else{
				return false;
			}
		}
		function trim(str){
			return str.replace(/(^\s*)|(\s*$)/g,"");
		}
		
		function addToCart(bookId){
			$.ajax({
				url: "/books/add_to_cart/" + bookId,
				data: {}, 
				type: "post",
				async: "true", 
				success: function(data){
					if(data.status=="success"){
						$("#add").hide();
						$("#added").show();
					}
					else{
						alert(data.status);
					}
				},
				error: function(){
					alert("error");
				}, 
				dataType: "json"
			});
		}
		
		function mark(bookId){
			var grade = $("#grade").val();
			if(grade < 1){
				alert("最低分为1分");
				return;
			}
			
			$.ajax({
				url: "/books/mark_book/" + bookId,
				data: {"grade": grade}, 
				type: "post",
				async: "true", 
				success: function(data){
					if(data.status=="success"){
						$("#mark_grade").hide();
						$("#marked").show();
					}
					else{
						alert(data.status);
					}
				},
				error: function(){
					alert("error");
				},
				dataType: "json"
			});
		}
		
		function addComment(bookId){
			var cmtContent = $("#comment").val();
			if(isNull(cmtContent)){
				alert("评论内容不能为空！");
				return;			}
			
			$.ajax({
				url: "/books/add_comment/" + bookId,
				data: {"cmtContent": cmtContent}, 
				type: "post",
				async: "true",
				success: function(data){
					if(data.status=="success"){
						$("#commentsArea").html(data.html);
					}
					else{
						alert(data.status);
					}
				},
				error: function(){
					alert("error");
				}, 
				dataType: "json"
			});
			$("#comment").val('')
		}
	</script>
{% endblock %}

{% block body_base %}
<div class="row-fluid">
	<div class="span2">
    	<div class="page-header">
            <h1>推荐</h1>
      	</div>
    	
    	<ul class="thumbnails">
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>吸血鬼的故事</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>吸血鬼的故事2</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>吸血鬼的故事3</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>吸血鬼的故事4</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>吸血鬼的故事5</h5>
            </a>
          </li>
        </ul>
        
        <div class="page-header">
            <h1>新书</h1>
        </div>
    	
    	<ul class="thumbnails">
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>新书1</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>新书2</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>新书3</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>新书4</h5>
            </a>
          </li>
          <li class="span12 text-center">
            <a href="#" class="thumbnail">
              <img src="static/base/img/de.png" alt="">
              <h5>新书5</h5>
            </a>
          </li>
        </ul>
    </div>
    <div class="span9 offset1">
        <div class="page-header">
            <h1>{{book.name}}</h1>
        </div>
        <div class="row-fluid">
        <!-- 缩略图 -->
        	<div class="span4">
            	<ul class="thumbnails">
                  <li class="span12">
                    <div class="thumbnail">
                      <img src="{{ MEDIA_URL }}img/{{book.lpic}}" alt="">
                    </div>
                  </li>
                </ul>
            </div>
        <!-- 详细参数 -->
        	<div class="span8">
                <dl class="dl-horizontal">
                    <dt>作者：</dt>
                    <dd>{{book.author.name|default:"&nbsp;"}}</dd>
                    <dt>出版社：</dt>
                    <dd>{{book.press|default:"&nbsp;"}}</dd>
                    <dt>ISBN：</dd>
                    <dd>{{book.isbn|default:"&nbsp;"}}</dt>
                    <dt>发布时间：</dd>
                    <dd>{{book.publish_date|default:"&nbsp;"}}</dt>
                    <dt>页数：</dd>
                    <dd>{{book.pages|default:"&nbsp;"}}页</dt>
                    <dt>装帧：</dd>
                    <dd>{{book.binding|default:"&nbsp;"}}</dt>                                                
                    <dt>库存：</dd>
                    <dd>{{book.stock|default:"&nbsp;"}}</dt>
                    <dt>售价：</dd>
                    <dd>{{book.price|default:"&nbsp;"}}元</dt>                                     
                </dl>
            </div>            
        </div>
        
        <div class="row-fluid">
        <!-- Share 
            <div class="span4">
                <small>分享至</small> 新浪微博 腾讯微博
            </div>  
         -->
        <!-- buy -->
            <div class="span8">
                <button class="btn btn-success pull-right"><i class="icon-shopping-cart icon-white"></i> 购买</button>
            </div>           
        </div>
        
        <br />
        <ul class="breadcrumb" id="breadcrumb_menu">
          <li><a href="#content_intro" class="lead"><small>内容简介</small></a> <span class="divider">|</span></li>
          <li><a href="#authot_intro" class="lead"><small>作者简介</small></a> <span class="divider">|</span></li>
          <li><a href="#other_books" class="lead"><small>该作者其他书籍</small> </a><span class="divider">|</span></li>
          <li><a href="#valuation" class="lead"><small>用户评价</small></a></li>           
        </ul>
                    
        <div class="row-fluid">
        	<div class="page-header">
                <h3 id="content_intro">内容简介：</h3>
            </div>
            <div class="span12">
            	{{book.desc}}
                <p><a href="#breadcrumb_menu"><span class="badge badge-success"><i class="icon-circle-arrow-up icon-white"></i> Top</span></a></p>
            </div>
        </div>
        <div class="row-fluid">
        	<div class="page-header">
                <h3 id="authot_intro">作者简介：</h3>
            </div>
            <div class="span12">
                {{book.author.desc}}
                <p><a href="#breadcrumb_menu"><span class="badge badge-success"><i class="icon-circle-arrow-up icon-white"></i> Top</span></a></p>
            </div>
        </div>
        <div class="row-fluid">
        	<div class="page-header">
            	<h3 id="other_books">该作者的其他书籍</h3>
            </div>
            <div class="span12">
            	<ul class="thumbnails">
            		{% for book in otherBooks %}
                    <li class="span2 text-center">
                        <a href="{% url book_detail book.id %}" class="thumbnail">
		                    <img src="{{ MEDIA_URL }}img/{{book.spic}}" alt="">
                            <small>{{book.name}}</small>
        	            </a>
                    </li>
                    {% endfor %}
                </ul>
                <p><a href="#breadcrumb_menu"><span class="badge badge-success"><i class="icon-circle-arrow-up icon-white"></i> Top</span></a></p>
            </div>
        </div>
        
        <div class="row-fluid">
            <div class="page-header">
            	<h3 id="valuation">评价</h3>
            </div>
        	<div class="span12">
        		{% ifnotequal allCmtsCount 0 %}
            	<div class="progress progress-striped active">
                  <div class="bar bar-success" style="width: {{positiveCmtsPercent}}%;">好评（{{positiveCmtsPercent|floatformat:"0"}}%）</div>
                  <div class="bar bar-warning" style="width: {{normalCmtsPercent}}%;">中评（{{normalCmtsPercent|floatformat:"0"}}%）</div>
                  <div class="bar bar-danger" style="width: {{negativeCmtsPercent}}%;">差评（{{negativeCmtsPercent|floatformat:"0"}}%）</div>
                </div>
                {% endifnotequal %}
            </div>
            <div class="span12">
                <div class="tabbable"> <!-- Only required for left/right tabs -->
                  <ul class="nav nav-tabs">
                    <li class="active"><a href="#tab1" data-toggle="tab">全部评价（{{book.countAllComments}}）</a></li>
                    <li><a href="#tab2" data-toggle="tab">好评（{{book.countPositiveComments}}）</a></li>
                    <li><a href="#tab3" data-toggle="tab">中评（{{book.countNormalComments}}）</a></li>
                    <li><a href="#tab4" data-toggle="tab">差评（{{book.countNegativeComments}}）</a></li>
                  </ul>
                  <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                    	<div id="cmt_all">
                    		{% include "books/includes/cmtlist_all.html" %}
                    	</div>
                    </div>
                    <div class="tab-pane" id="tab2">
                    	<div id="cmt_positive">
                    		{% include "books/includes/cmtlist_positive.html" %}
                    	</div>
                    </div>
                    <div class="tab-pane" id="tab3">
                    	<div id="cmt_normal">
                    		{% include "books/includes/cmtlist_normal.html" %}
                    	</div>
                    </div>
                    <div class="tab-pane" id="tab4">
                    	<div id="cmt_negative">
                    		{% include "books/includes/cmtlist_negative.html" %}
                    	</div>
                    </div>
                  </div>
                </div>
            </div>
        </div>            
    </div>
</div>	
{% endblock %}
